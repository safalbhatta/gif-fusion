<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>GIF Preview</title>
  <style>
    body{font-family:Inter, Arial, sans-serif;background:#071022;color:#e6eef6;display:flex;align-items:center;justify-content:center;height:100vh;margin:0;padding:18px}
    .card{width:100%;max-width:760px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));padding:18px;border-radius:12px;border:1px solid rgba(255,255,255,0.03);box-shadow:0 8px 30px rgba(2,6,23,0.6)}
    .player{display:flex;gap:16px;align-items:flex-start}
    .stage{flex:1;display:flex;align-items:center;justify-content:center;padding:12px;background:rgba(255,255,255,0.02);border-radius:8px;height:420px}
    .stage img{max-width:100%;max-height:100%;border-radius:6px}
    .controls{width:220px}
    .thumbs{display:flex;flex-wrap:wrap;gap:8px;margin-top:12px}
    .thumb{width:56px;height:56px;background:rgba(255,255,255,0.02);border-radius:6px;overflow:hidden;display:flex;align-items:center;justify-content:center;cursor:pointer}
    .thumb img{width:100%;height:100%;object-fit:cover}
    .meta{color:#9aa4b2;font-size:13px;margin-bottom:8px}
    .btn{display:inline-block;padding:8px 12px;border-radius:8px;background:#6ee7b7;color:#072027;font-weight:700;border:none;cursor:pointer}
    .btn.ghost{background:transparent;color:#9aa4b2;border:1px solid rgba(255,255,255,0.04)}
    .row{display:flex;gap:8px;align-items:center}
    input[type=range]{width:100%}
    .placeholder{color:#9aa4b2}
  </style>
</head>
<body>
  <div class="card">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <div style="font-weight:700;font-size:18px">GIF Preview</div>
      <div>
        <button id="closeBtn" class="btn ghost">Close</button>
      </div>
    </div>

    <div class="player" style="margin-top:12px">
      <div class="stage" id="stage"><div class="placeholder">Waiting for images from the main pageâ€¦</div></div>
      <div class="controls">
        <div class="meta">Frames: <span id="frameCount">0</span></div>
        <div class="row"><button id="playBtn" class="btn">Play</button><button id="pauseBtn" class="btn ghost">Pause</button></div>
        <div style="margin-top:10px" class="meta">Speed (ms per frame)</div>
        <div class="row"><input id="speed" type="range" min="50" max="2000" step="10" value="200"><div id="speedVal" style="width:56px;text-align:right">200</div></div>
        <div style="margin-top:8px" class="meta">Loop</div>
        <div class="row"><label style="display:flex;gap:8px;align-items:center"><input id="loop" type="checkbox" checked>Enable</label></div>
        <div style="margin-top:12px" class="meta">Thumbnails</div>
        <div id="thumbs" class="thumbs"></div>
        <div style="margin-top:12px" class="row">
          <button id="applyBtn" class="btn">Apply order</button>
          <button id="applyCloseBtn" class="btn ghost">Apply & Close</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Send ready handshake to opener (if any)
    function sendReady(){
      if (window.opener && !window.opener.closed){
        try{ window.opener.postMessage({ type: 'preview-ready' }, window.location.origin); } catch(e){}
      }
    }

  // Player state
  // each frame is an object { id: originalIndex, url: dataUrl }
  let frames = [];
    let current = 0;
    let timer = null;
    let playing = false;

    const stage = document.getElementById('stage');
    const playBtn = document.getElementById('playBtn');
    const pauseBtn = document.getElementById('pauseBtn');
    const speed = document.getElementById('speed');
    const speedVal = document.getElementById('speedVal');
    const frameCount = document.getElementById('frameCount');
    const thumbs = document.getElementById('thumbs');
    const loopCheckbox = document.getElementById('loop');
    const closeBtn = document.getElementById('closeBtn');

    function renderFrame(i){
      if (!frames.length) return;
      current = ((i % frames.length) + frames.length) % frames.length;
      stage.innerHTML = '';
      const img = document.createElement('img'); img.src = frames[current].url; img.alt = 'frame '+(current+1);
      stage.appendChild(img);
      // highlight thumb
      Array.from(thumbs.children).forEach((t, idx)=> t.style.outline = idx===current ? '2px solid rgba(96,165,250,0.9)' : '');
    }

    function startPlaying(){
      if (playing || frames.length===0) return;
      playing = true;
      const ms = parseInt(speed.value,10) || 200;
      timer = setInterval(()=>{
        current = (current + 1) % frames.length;
        renderFrame(current);
        if (!loopCheckbox.checked && current === frames.length-1){ stopPlaying(); }
      }, ms);
    }
    function stopPlaying(){ playing = false; if (timer) clearInterval(timer); timer = null; }

    playBtn.addEventListener('click', ()=>{ startPlaying(); });
    pauseBtn.addEventListener('click', ()=>{ stopPlaying(); });
    speed.addEventListener('input', ()=>{ speedVal.innerText = speed.value; if (playing){ stopPlaying(); startPlaying(); } });
    closeBtn.addEventListener('click', ()=>{ window.close(); });

    // Build thumbs
    function buildThumbs(){
      thumbs.innerHTML = '';
      frames.forEach((f,i)=>{
        const d = document.createElement('div'); d.className='thumb'; d.draggable = true;
        const img = document.createElement('img'); img.src = f.url; img.alt = 'thumb '+(i+1);
        d.appendChild(img);
        d.onclick = ()=>{ renderFrame(i); };
        // drag handlers for reordering
        d.addEventListener('dragstart', (ev)=>{ ev.dataTransfer.setData('text/plain', i); d.style.opacity = '0.4'; });
        d.addEventListener('dragend', ()=>{ d.style.opacity = ''; });
        d.addEventListener('dragover', (ev)=>{ ev.preventDefault(); });
        d.addEventListener('drop', (ev)=>{
          ev.preventDefault();
          const from = parseInt(ev.dataTransfer.getData('text/plain'), 10);
          const to = Array.from(thumbs.children).indexOf(d);
          if (!isNaN(from) && from !== to){
            const item = frames.splice(from,1)[0];
            frames.splice(to,0,item);
            buildThumbs();
            renderFrame(to);
          }
        });

        thumbs.appendChild(d);
      });
    }

    // Message handler - receive frames from opener
    window.addEventListener('message', (e)=>{
      try{
        const originOk = e.origin === window.location.origin;
        // allow same-origin only
        if (!originOk) return;
        const msg = e.data || {};
        if (msg.type === 'preview-frames' && Array.isArray(msg.frames)){
          // incoming frames should be objects { id, url }
          frames = msg.frames.slice();
          frameCount.innerText = frames.length;
          buildThumbs();
          renderFrame(0);
        }
      }catch(err){ console.error(err); }
    }, false);

    // Apply order back to opener
    const applyBtn = document.getElementById('applyBtn');
    const applyCloseBtn = document.getElementById('applyCloseBtn');
    function postOrder(closeAfter){
      if (window.opener && !window.opener.closed){
        const order = frames.map(f => f.id);
        try{
          window.opener.postMessage({ type: 'preview-order', order }, window.location.origin);
        }catch(e){ console.error(e); }
      }
      if (closeAfter) window.close();
    }
    applyBtn.addEventListener('click', ()=> postOrder(false));
    applyCloseBtn.addEventListener('click', ()=> postOrder(true));

    // If opened by a parent, announce readiness
    sendReady();

    // Also try to re-send ready after a short delay in case opener attaches listener after opening
    setTimeout(sendReady, 200);
  </script>
</body>
</html>
